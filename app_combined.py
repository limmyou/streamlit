# -*- coding: utf-8 -*-
"""app_combined.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ssSaKHeu_rDZMQOUDoJdP3xGMm5AU18h
"""

import streamlit as st
import requests
import pymysql
import pytz
from datetime import datetime
import pandas as pd
import io
from PIL import Image
import zipfile
from st_aggrid import AgGrid, GridOptionsBuilder

st.write("HOST:", st.secrets.get("MYSQLHOST"))
st.write("USER:", st.secrets.get("MYSQLUSER"))
st.write("PWD:", st.secrets.get("MYSQLPASSWORD"))

# FastAPI URL ìˆ˜ì •
FASTAPI_URL_DETECT = "https://fastapi-production-c437.up.railway.app/detect"
FASTAPI_URL_SEGMENT = "https://fastapi-production-c437.up.railway.app/segment"
FASTAPI_STATUS_URL = "https://fastapi-production-c437.up.railway.app/status"

# MariaDB ì—°ê²° ì„¤ì •
def get_connection():
    return pymysql.connect(
        host=st.secrets["MYSQLHOST"],
        user=st.secrets["MYSQLUSER"],
        password=st.secrets["MYSQLPASSWORD"],
        database=st.secrets["MYSQLDATABASE"],
        port=int(st.secrets["MYSQLPORT"]),
        cursorclass=pymysql.cursors.DictCursor,
        charset="utf8mb4",
        autocommit=True
    )

def save_user_log(name, timestamp):
    try:
        conn = get_connection()
        cursor = conn.cursor()
        query = "INSERT INTO user_log (name, access_time) VALUES (%s, %s)"
        cursor.execute(query, (name, timestamp))
        conn.commit()
        conn.close()
    except Exception as e:
        st.error(f"[ì‚¬ìš©ì ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨] {e}")

def insert_to_image_data(name, filename, info_value, filesize, inference_time, timestamp, mode):
    try:
        conn = get_connection()
        cursor = conn.cursor()

        if mode == "detect":  # YOLO
            query = """
                INSERT INTO image_data (name, filename, object_count, filesize, inference_time, timestamp)
                VALUES (%s, %s, %s, %s, %s, %s)
            """
            params = (name, filename, info_value, filesize, inference_time, timestamp)

        else:  # DeepLab
            query = """
                INSERT INTO image_data_dlab (name, filename, area_count, inference_time, timestamp)
                VALUES (%s, %s, %s, %s, %s)
            """
            params = (name, filename, info_value, inference_time, timestamp)

        cursor.execute(query, params)
        conn.commit()
        conn.close()
        return True

    except Exception as e:
        st.error(f"[DB ì €ì¥ ì‹¤íŒ¨] {e}")
        return False

# =========================================================
# Streamlit ê¸°ë³¸ ì„¤ì •
# =========================================================
st.set_page_config(page_title="ì´ë¯¸ì§€ ë¶„ì„ ì‹œìŠ¤í…œ", layout="wide")
st.markdown("<h1 style='text-align:center;'>ì´ë¯¸ì§€ ë¶„ì„ ì‹œìŠ¤í…œ</h1>", unsafe_allow_html=True)

# =========================================================
# íƒ­ êµ¬ì„±
# =========================================================
tab1, tab2 = st.tabs(["ì´ë¯¸ì§€ ì—…ë¡œë“œ", "DB ê²°ê³¼ ì¡°íšŒ"])

# =========================================================
# TAB 1 - ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë¶„ì„
# =========================================================
with tab1:
    name = st.text_input("ì‚¬ìš©ì ì´ë¦„")
    if name and "saved_name" not in st.session_state:
        now_kst = datetime.now(pytz.timezone("Asia/Seoul"))
        save_user_log(name, now_kst)
        st.session_state.saved_name = name
        st.success(f"'{name}' ì ‘ì† ê¸°ë¡ ì €ì¥ ì™„ë£Œ")

    # ğŸ”¹ ëª¨ë¸ ì„ íƒ
    model_choice = st.radio("ëª¨ë¸ ì„ íƒ", ["ê°ì²´ íƒì§€ (YOLO)", "ë©´ì  ë¶„í•  (DeepLabV3+)"])

    uploaded_file = st.file_uploader("ì´ë¯¸ì§€ ë˜ëŠ” ZIP íŒŒì¼ ì—…ë¡œë“œ", type=["jpg", "jpeg", "png", "zip"])
    if uploaded_file and not name:
        st.warning("ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.")
        st.stop()

    if uploaded_file and name:
        now_kst = datetime.now(pytz.timezone("Asia/Seoul"))
        api_url = FASTAPI_URL_DETECT if model_choice == "ê°ì²´ íƒì§€ (YOLO)" else FASTAPI_URL_SEGMENT

        try:
            status_response = requests.get(FASTAPI_STATUS_URL)
            if status_response.ok and status_response.json().get("status") == "busy":
                st.warning("ëª¨ë¸ì´ ì¶”ë¡  ì¤‘ì…ë‹ˆë‹¤.")
                st.stop()
        except:
            pass  # segmentation ëª¨ë¸ì—ëŠ” status endpoint ì—†ìœ¼ë¯€ë¡œ ë¬´ì‹œ

        # ğŸ”¸ ZIP íŒŒì¼ ì²˜ë¦¬
        if uploaded_file.name.lower().endswith(".zip"):
            results = []
            try:
                with zipfile.ZipFile(uploaded_file) as z:
                    image_infos = [info for info in z.infolist() if info.filename.lower().endswith((".jpg", ".jpeg", ".png"))]
                    if not image_infos:
                        st.warning("ì••ì¶• íŒŒì¼ì— ìœ íš¨í•œ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")
                        st.stop()

                    for info in image_infos:
                        file_bytes = z.read(info)
                        try:
                            response = requests.post(api_url, files={"file": file_bytes})
                            if response.status_code == 200:
                                result = response.json()
                                if model_choice == "ê°ì²´ íƒì§€ (YOLO)":
                                    info_value = result.get("object_count", 0)  # YOLOì˜ ê²°ê³¼ì¸ object_countë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤
                                    mode = "detect"
                                else:
                                    info_value = result.get("area_cm2_assumed", 0)
                                    mode = "segment"

                                inference_time = result.get("inference_time_ms", 0) / 1000
                                filesize = uploaded_file.size  # íŒŒì¼ í¬ê¸°
                                insert_to_image_data(name, info.filename, info_value, filesize, inference_time, now_kst, mode)

                                results.append({"íŒŒì¼ëª…": info.filename, "ê²°ê³¼": info_value})
                            else:
                                results.append({"íŒŒì¼ëª…": info.filename, "ê²°ê³¼": "ì‹¤íŒ¨"})
                        except Exception as e:
                            st.warning(f"{info.filename} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

                if results:
                    st.dataframe(pd.DataFrame(results), use_container_width=True)
            except Exception as e:
                st.error(f"ZIP ì²˜ë¦¬ ì˜¤ë¥˜: {e}")

        # ğŸ”¸ ë‹¨ì¼ ì´ë¯¸ì§€ ì²˜ë¦¬
        else:
            file_bytes = uploaded_file.getvalue()
            try:
                response = requests.post(api_url, files={"file": file_bytes})
                if response.status_code == 200:
                    result = response.json()
                    inference_time = result.get("inference_time_ms", 0) / 1000

                    if model_choice == "ê°ì²´ íƒì§€ (YOLO)":
                        info_value = result.get("object_count", 0)
                        st.success(f"íƒì§€ëœ ê°œì²´ ìˆ˜: {info_value}ê°œ")
                        mode = "detect"
                    else:
                        info_value = result.get("area_cm2_assumed", 0)
                        area_ratio = result.get("area_ratio_percent", 0)
                        st.success(f"ë©´ì : {info_value} cmÂ² ({area_ratio:.2f}%)")
                        mode = "segment"

                    filesize = uploaded_file.size  # íŒŒì¼ í¬ê¸°
                    insert_to_image_data(name, uploaded_file.name, info_value, filesize, inference_time, now_kst, mode)
                    st.success("DB ì €ì¥ ì™„ë£Œ")

                else:
                    st.error(f"API ì‘ë‹µ ì‹¤íŒ¨ (Status {response.status_code})")
            except Exception as e:
                st.error(f"FastAPI ìš”ì²­ ì‹¤íŒ¨: {e}")

# =========================================================
# TAB 2 - DB ê²°ê³¼ ì¡°íšŒ
# =========================================================
with tab2:
    st.subheader("ìµœê·¼ ê¸°ë¡ ì¡°íšŒ")

    # ğŸ”¹ ì–´ë–¤ ëª¨ë¸ì˜ DBë¥¼ ì¡°íšŒí• ì§€ ì„ íƒ
    db_choice = st.radio("ì¡°íšŒí•  ëª¨ë¸ ì„ íƒ", ["ê°ì²´ íƒì§€ (YOLO)", "ë©´ì  ë¶„í•  (DeepLabV3+)"])

    query_name = st.text_input("ì‚¬ìš©ì ì´ë¦„", key="query_name")

    try:
        conn = get_connection()

        if db_choice == "ê°ì²´ íƒì§€ (YOLO)":
            base_query = """
                SELECT name, filename, object_count, inference_time, timestamp
                FROM image_data
                ORDER BY timestamp DESC
                LIMIT 30
            """
            name_query = """
                SELECT name, filename, object_count, inference_time, timestamp
                FROM image_data
                WHERE name = %s
                ORDER BY timestamp DESC
            """
            column_names = ["ì‚¬ìš©ì", "íŒŒì¼ëª…", "ê°ì²´ ìˆ˜", "ì¶”ë¡  ì‹œê°„(ì´ˆ)", "ì—…ë¡œë“œ ì‹œê°"]

        else:  # DeepLab
            base_query = """
                SELECT name, filename, area_count, inference_time, timestamp
                FROM image_data_dlab
                ORDER BY timestamp DESC
                LIMIT 30
            """
            name_query = """
                SELECT name, filename, area_count, inference_time, timestamp
                FROM image_data_dlab
                WHERE name = %s
                ORDER BY timestamp DESC
            """
            column_names = ["ì‚¬ìš©ì", "íŒŒì¼ëª…", "ë©´ì  ê°œìˆ˜", "ì¶”ë¡  ì‹œê°„(ì´ˆ)", "ì—…ë¡œë“œ ì‹œê°"]

        df = pd.read_sql(name_query, conn, params=[query_name]) if query_name else pd.read_sql(base_query, conn)
        conn.close()

        if not df.empty:
            df.columns = column_names
            st.dataframe(df, use_container_width=True)

            today_str = datetime.now(pytz.timezone("Asia/Seoul")).strftime('%y%m%d')
            filename = f"results_{query_name or 'all'}_{today_str}.xlsx"

            excel_buffer = io.BytesIO()
            with pd.ExcelWriter(excel_buffer, engine='openpyxl') as writer:
                df.to_excel(writer, index=False, sheet_name="Results")

            st.download_button(
                label="ê²°ê³¼ ë‹¤ìš´ë¡œë“œ",
                data=excel_buffer.getvalue(),
                file_name=filename,
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
        else:
            st.info("ì¡°íšŒí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

    except Exception as e:
        st.error(f"[DB ì¡°íšŒ ì‹¤íŒ¨] {e}")

